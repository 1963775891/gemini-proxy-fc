# Gemini Proxy 产品需求文档

## 1. 产品概述

### 1.1 产品名称
Gemini Proxy - 阿里云函数计算 Gemini API 代理服务

### 1.2 产品定位
一个运行在阿里云函数计算上的 Gemini API 代理服务，提供 OpenAI 兼容的 API 接口，帮助中国大陆用户无障碍访问 Google Gemini AI 模型。

### 1.3 产品背景
- 中国大陆无法直接访问 Google Gemini API
- 现有的 OpenAI 客户端库需要适配才能使用其他 AI 模型
- 开发者需要一个稳定、高效的 Gemini 访问方案
- 无服务器架构可以提供更好的成本效益和可扩展性


## 2. 产品目标

1. **访问性**：解决中国大陆无法直接访问 Gemini API 的问题
2. **兼容性**：提供与 OpenAI API 完全兼容的接口格式
3. **可靠性**：保证 99.9% 的服务可用性
4. **性能**：响应延迟控制在 2 秒以内
5. **安全性**：提供身份验证和访问控制机制

## 3. 功能需求

### 3.1 核心功能

#### 3.1.1 聊天完成 API (Chat Completions)
**功能描述**：提供与 OpenAI Chat Completions 兼容的 Gemini 对话接口

**接口规范**：
- **端点**：`POST /v1/chat/completions`
- **请求格式**：符合 OpenAI API 标准
- **响应格式**：符合 OpenAI API 标准
- **支持参数**：
  - `model`: 支持的 Gemini 模型
  - `messages`: 对话消息数组
  - `temperature`: 0.0-2.0 之间的创造性控制
  - `max_tokens`: 最大输出 token 数量
  - `stream`: 是否启用流式响应

**支持的模型列表**：
- gemini-2.5-flash
- gemini-2.5-pro
- gemini-2.5-flash-lite-preview-06-17
- gemini-2.0-flash
- gemini-2.0-flash-lite
- gemini-1.5-pro
- gemini-1.5-flash
- gemini-1.5-flash-8b

#### 3.1.2 模型列表 API (Models)
**功能描述**：返回支持的 Gemini 模型列表

**接口规范**：
- **端点**：`GET /v1/models`
- **响应格式**：符合 OpenAI Models API 标准
- **返回信息**：模型 ID、创建时间、所有者等

#### 3.1.3 流式响应支持
**功能描述**：支持 Server-Sent Events (SSE) 格式的流式响应

**技术要求**：
- 实时输出 AI 生成内容
- 符合 OpenAI 流式响应格式
- 支持连接中断和重连机制
- 适当的缓冲和错误处理

#### 3.1.4 身份验证机制
**功能描述**：提供基于 Bearer Token 的身份验证

**安全要求**：
- 支持自定义 AUTH_TOKEN 环境变量
- Bearer Token 格式验证
- 无效 Token 返回 401 错误
- 向后兼容（可选的身份验证）

### 3.2 系统功能

#### 3.2.1 健康检查
**功能描述**：提供系统状态和配置信息查询

**接口规范**：
- **端点**：`GET /health`
- **返回信息**：
  - 服务状态
  - 版本信息
  - 支持的模型数量
  - 功能特性列表
  - 身份验证状态

#### 3.2.2 错误处理
**功能描述**：统一的错误处理和响应机制

**错误类型**：
- 401 Unauthorized：身份验证失败
- 400 Bad Request：请求参数错误
- 404 Not Found：接口不存在
- 500 Internal Server Error：服务内部错误
- 502 Bad Gateway：上游 API 错误

#### 3.2.3 CORS 支持
**功能描述**：支持跨域资源共享

**配置要求**：
- 允许所有来源 (*)
- 支持 OPTIONS 预检请求
- 包含必要的 CORS 头部

### 3.3 监控和日志

#### 3.3.1 请求日志
**日志内容**：
- 请求时间戳
- 请求方法和路径
- 用户身份信息
- 响应状态码
- 处理时长
- 错误信息（如有）

#### 3.3.2 性能监控
**监控指标**：
- API 响应时间
- 错误率统计
- 并发请求数
- 资源使用情况

## 4. 技术需求

### 4.1 运行环境
- **平台**：阿里云函数计算 (Function Compute)
- **运行时**：Node.js 20.x 或更高版本
- **内存配置**：推荐 256MB 或以上
- **超时时间**：推荐 120 秒
- **触发器**：HTTP 触发器

### 4.2 依赖项
**生产依赖**：
- `openai@^4.63.0`: OpenAI SDK 用于调用 Gemini API

**开发依赖**：
- `colors@^1.4.0`: 彩色输出工具
- `node-fetch@^3.3.2`: HTTP 请求库

### 4.3 环境变量
**必需变量**：
- `GEMINI_API_KEY`: Google Gemini API 密钥

**可选变量**：
- `AUTH_TOKEN`: 自定义身份验证令牌

### 4.4 架构设计
- **无服务器架构**：基于阿里云函数计算
- **事件驱动**：HTTP 事件触发处理
- **无状态设计**：不依赖本地存储
- **代理模式**：转发请求到 Gemini API

## 5. 部署需求

### 5.1 部署步骤
1. 创建阿里云函数计算函数
2. 配置运行时环境和资源
3. 上传代码文件
4. 安装依赖包
5. 配置环境变量
6. 创建 HTTP 触发器
7. 配置自定义域名（可选）

### 5.2 配置要求
- **函数名称**：gemini-proxy
- **运行时**：Node.js 20
- **内存规格**：256MB-512MB
- **超时时间**：60-120 秒
- **并发度**：根据需求调整

### 5.3 网络配置
- **公网访问**：启用
- **VPC**：可选配置
- **安全组**：允许 HTTPS 出站流量

## 6. 测试需求

### 6.1 功能测试
**测试用例**：
1. 健康检查测试
2. 模型列表获取测试
3. 聊天完成（非流式）测试
4. 聊天完成（流式）测试
5. OpenAI 客户端兼容性测试
6. 身份验证机制测试
7. 错误处理测试
8. CORS 功能测试

### 6.2 性能测试
**测试场景**：
1. 单用户性能测试
2. 并发用户测试
3. 长时间运行稳定性测试
4. 流式响应性能测试

### 6.3 安全测试
**测试内容**：
1. 身份验证绕过测试
2. 无效令牌处理测试
3. 恶意请求防护测试
4. API 密钥泄露防护测试

